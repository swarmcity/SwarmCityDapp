<script src="../../../node_modules/tweetnacl/nacl.min.js"></script>
<script src="../../../node_modules/tweetnacl-util/nacl-util.min.js"></script>

<script>
  (function () {
    // Base64 reserved characters: "+", "/", "="
    const splitChypherCharacter = "."; // MUST NOT be a base64 character

    /**
     * Encrypts utf-8 message, can be a stringified json.
     * Uses authentication encryption.
     * @param {String} messageUtf8 must be a utf-8 string
     * @param {Uint8Array} key 
     * @return {String} envelop, concatenation of the chyper text and the nonce base64 encoded
     */
    function encrypt(messageUtf8, keyEncoded) {
      const { nacl } = window
      if (!nacl) throw Error('Library tweet-nacl in not available in the global scope')

      const nonce = nacl.randomBytes(nacl.secretbox.nonceLength);
      const message = nacl.util.decodeUTF8(messageUtf8);
      const key = nacl.util.decodeBase64(keyEncoded);
      // Encrypt
      const box = nacl.secretbox(message, nonce, key);
      if (!box) throw Error('Error encoding message \'' + message + '\' ')
      // Concat
      const nonceEncoded = nacl.util.encodeBase64(nonce);
      const boxEncoded = nacl.util.encodeBase64(box);
      return [nonceEncoded, boxEncoded].join(splitChypherCharacter)
    }

    /**
     * Decrypts envelope
     * @param {String} envelope Must be a concatenation of the chyper text and the nonce base64 encoded
     * using the predefined splitChypherCharacter
     * @param {Uint8Array} key 
     * @return {String} utf-8 message
     */
    function decrypt(envelope, keyEncoded) {
      const { nacl } = window
      if (!nacl) throw Error('Library tweet-nacl in not available in the global scope')

      // Split
      const [nonceEncoded, boxEncoded] = envelope.split(splitChypherCharacter)
      const nonce = nacl.util.decodeBase64(nonceEncoded);
      const box = nacl.util.decodeBase64(boxEncoded);
      const key = nacl.util.decodeBase64(keyEncoded);
      // Decrypt
      const message = nacl.secretbox.open(box, nonce, key);
      return message ? nacl.util.encodeUTF8(message) : null;
    }

    function getRandomKey() {
      const key = nacl.randomBytes(nacl.secretbox.keyLength);
      return nacl.util.encodeBase64(key);
    }

    window.symmetric = {
      encrypt,
      decrypt,
      getRandomKey
    }

    // Import contract data:
    // const { kovSwtToken, hashtagList, simpleDeal } = window.contractsData;
  })();
</script>