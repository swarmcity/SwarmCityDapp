<script>
    (function () {

        /**
         * Class with private properties to handle encryption
         */

        // Tutorial, how to use symmetric encryption for chat
        // const givenChatKey = 'some-chat-key'
        // const givenChatId = 'some-chat-id'
        // 
        // > On the sender's side:
        // ledger.setSymmetricKey(givenChatKey, givenChatId)
        // const message = 'hello'
        // const envelope = ledger.symmetric.encrypt(message, givenChatId)
        // > Send the envelope to the receiver
        // 
        // > On the receiver side:
        // ledger.setSymmetricKey(givenChatKey, givenChatId)
        // const message = ledger.symmetric.decrypt(envelope, givenChatId)
        // > done

        let privateKey;
        let publicKey;
        let symmetricKeys = {}

        const { asymmetric, symmetric } = window

        window.ledger = {
            symmetric: {
                encrypt: (messageUtf8, id) => {
                    const keyEncoded = symmetricKeys[id]
                    if (!keyEncoded) throw Error('No key found for ID: ' + id)
                    return symmetric.encrypt(messageUtf8, keyEncoded)
                },
                decrypt: (envelope, id) => {
                    const keyEncoded = symmetricKeys[id]
                    if (!keyEncoded) throw Error('No key found for ID: ' + id)
                    return symmetric.decrypt(envelope, keyEncoded)
                }
            },
            asymmetric: {
                encrypt: (messageUtf8) => {
                    if (!privateKey) throw Error('This ledger has no privateKey yet')
                    return asymmetric.encrypt(messageUtf8, publicKey)
                },
                decrypt: (envelope) => {
                    if (!privateKey) throw Error('This ledger has no privateKey yet')
                    return asymmetric.decrypt(envelope, privateKey)
                }
            },
            setPrivateKey: (_privateKey) => {
                privateKey = _privateKey
            },
            deletePrivateKey: () => {
                privateKey = null
            },
            setSymmetricKey: (symmetricKey, id) => {
                if (!id) throw Error('You must pass an ID to store the symmetricKey')
                symmetricKeys[id] = symmetricKey
            },
            deleteSymmetricKey: (id) => {
                if (!id) throw Error('You must pass an ID to store the symmetricKey')
                delete symmetricKeys[id]
            },
            hasPrivateKey: () => {
                return Boolean(privateKey)
            },
            hasSymmetricKey: (id) => {
                return Boolean(symmetricKeys[id])
            },
            listSymmetricKeysIds: () => {
                return Object.keys(symmetricKeys)
            },
            //
            // FOR TESTING
            //
            setRandomPrivateKey: () => {
                const identity = asymmetric.randomIdentity()
                privateKey = identity.privateKey
                publicKey = identity.publicKey
            },
            setRandomSymmetricKey: () => {
                const symmetricKey = symmetric.getRandomKey()
                const id = String(Math.random()).slice(2)
                symmetricKeys[id] = symmetricKey
                return id
            }
        }

    })();
</script>