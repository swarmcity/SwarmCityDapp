<!--
@license
Copyright (c) 2018 Swarm City
This code may only be used under the license found at https://github.com/swarmcity/license
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<dom-module id="data-external">

    <script>
        class SocketRedux extends new ReduxMixin(Polymer.Element) {
            static get is() {
                return 'data-external';
            }
            static get properties() {
                return {
                    socket: {
                        type: Object,
                    },
                };
            }

            constructor() {
                super();
                // Create websocket
                this.socket = io('https://dev.swarm.city', // eslint-disable-line
                    {
                        query: 'apiUser=swarmCity',
                        path: '/api',
                        transports: ['websocket', 'xhr-polling'],
                        autoConnect: false,
                    });
            }

            ready() {
                super.ready();
                // Listen for changes in the exchange rates
                this.socket.on('fxChanged', (reply) => {
                    this.dispatch({
                        type: 'UPDATE_FX',
                        fx: reply
                    });
                });

                this.socket.connect();

                
            }

            static get properties() {
                return {

                    address: {
                        type: String,
                        statePath: AppStore.selectors.address,
                    },
                }
            }

            static get actions() {
                return Object.assign({
                    BALANCE: function (balance) {
                        return {
                            type: 'BALANCE',
                            balance: balance,
                        };
                    },
                })
            }
            _getShortCode(address, username, avatar) {
                return new Promise((resolve, reject) => {
                    this.socket.emit('subscribe', {
                        channel: 'createShortCode',
                        args: {
                            address: address,
                            userName: username,
                            avatar: avatar,
                        },
                    }, (reply) => {
                        if (reply.response == 200) {
                            resolve(reply.data.shortCode);
                        } else {
                            reject(reply.data);
                        }
                    });
                });
            }
        }
        window.customElements.define(SocketRedux.is, SocketRedux);
    </script>
</dom-module>