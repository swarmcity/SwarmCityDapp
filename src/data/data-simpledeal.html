<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="data-simpledeal">
    <script>
        class DataSimpledeal extends Polymer.Element {
            static get is() {
                return 'data-simpledeal';
            }

            /**
            * Create a new hashtag item
            * @param {String} itemHash - The itemHash in Hex (with prefix)
            * @param {Number} weiAmount - The item value in wei
            * @param {String} ipfsHash - The item's metadata ipfs hash
            * @param {String} contractAddress - The hashtag's address
            * @param {Object} abi - The hashtag contract's abi
            * @return {Object} - The Raw new item tx data
            */
            rawNewItem(itemHash, weiAmount, ipfsHash, contractAddress, abi) {
                return new Promise((resolve, reject) => {
                    const simpleDealContract = new webpack.Contract(
                        abi,
                        contractAddress
                    );
                    let rawNewItem = simpleDealContract.methods.newItem(
                        itemHash,
                        weiAmount,
                        ipfsHash
                    ).encodeABI();
                    resolve(rawNewItem);
                });
            }

            /**
            * Reply to an item
            * @param {String} itemHash - The itemHash in Hex (with prefix)
            * @param {String} ipfsHash - The reply data ipfs hash
            * @param {String} contractAddress - The hashtag's address
            * @param {Object} abi - The hashtag contract's abi
            * @return {Object} - The Raw reply tx data
            */
            rawReplyItem(itemHash, ipfsHash, contractAddress, abi) {
                return new Promise((resolve, reject) => {
                    const simpleDealContract = new webpack.Contract(
                        abi,
                        contractAddress
                    );
                    let rawReplyItem = simpleDealContract.methods.replyItem(
                        itemHash,
                        ipfsHash,
                    ).encodeABI();
                    resolve(rawReplyItem);
                });
            }

            /**
            * As seeker, select a replier to your item as potential provider
            * @param {String} itemHash - The itemHash in Hex (with prefix)
            * @param {String} replierAddress - The replier's address
            * @param {String} contractAddress - The hashtag's address
            * @param {Object} abi - The hashtag contract's abi
            * @return {Object} - The Raw reply tx data
            */
            rawSelectReplier(itemHash, replierAddress, contractAddress, abi) {
                return new Promise((resolve, reject) => {
                    const simpleDealContract = new webpack.Contract(
                        abi,
                        contractAddress
                    );
                    let rawSelectReplier = simpleDealContract.methods.selectReplier(
                        itemHash,
                        replierAddress,
                    ).encodeABI();
                    resolve(rawSelectReplier);
                });
            }

            /**
            * Fund a hashtag item
            * @param {String} itemHash - The itemHash of the item
            * @param {String} contractAddress - The hashtag's address
            * @param {Object} abi - The hashtag contract's abi
            * @return {Object} - The Raw new item tx data
            */
            rawFundItem(itemHash, contractAddress, abi) {
                return new Promise((resolve, reject) => {
                    const simpleDealContract = new webpack.Contract(
                        abi,
                        contractAddress
                    );
                    let rawFundItem = simpleDealContract.methods.fundItem(
                        itemHash
                    ).encodeABI();
                    resolve(rawFundItem);
                });
            }

            /**
            * Pay the provider the full sum
            * @param {String} itemHash - The itemHash in Hex (with prefix)
            * @param {String} contractAddress - The hashtag's address
            * @param {Object} abi - The hashtag contract's abi
            * @return {Object} - The Raw payout item tx data
            */
            rawPayoutItem(itemHash, contractAddress, abi) {
                return new Promise((resolve, reject) => {
                    const simpleDealContract = new webpack.Contract(abi, contractAddress);
                    let rawPayoutItem = simpleDealContract.methods.payoutItem(itemHash).encodeABI();
                    resolve(rawPayoutItem);
                });
            }

            /**
            * Filter the hashtag object to return a formatted list of items the user is involved in
            * @return {items} The array with items the user is involved in
            * @argument {object} hashtag the current hashtag
            * @argument {String} userAddress the user's address
            * @argument {String} involved if true, return the items the user is involved with
            */
            getHashtagItems(hashtag, userAddress, involved) {
                return new Promise((resolve, reject) => {
                    let items = Object.values(hashtag.items)
                        .filter((item) => {
                            let isInvolved = false;
                            if (item.replies) {
                                for (let i = 0; i < item.replies.length; i++) {
                                    if (item.replies[i].address == userAddress) {
                                        isInvolved = true;
                                    }
                                }
                            }
                            if (item.seeker.address == userAddress) {
                                isInvolved = true;
                            }
                            if (involved) {
                                // only return items the user is involved with
                                return isInvolved;
                            } else {
                                // only return items the user is not involved with
                                return !isInvolved;
                            }
                        })
                        .map((item) => {
                            // If missing seeker username, use address
                            item.seeker.username = item.seeker.username || item.seeker.address;
                            // If missing description, use default
                            item.description = item.description || 'Missing description';
                            return item;
                        })
                        .sort((a, b) => {
                            // sort the array by date, newest first
                            return parseInt(b.dateTime) - parseInt(a.dateTime);
                        });
                    resolve(items);
                });
            }
        } window.customElements.define(DataSimpledeal.is, DataSimpledeal);
    </script>
</dom-module>
